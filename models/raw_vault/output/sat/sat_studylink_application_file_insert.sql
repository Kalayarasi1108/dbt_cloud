-- INSERT
INSERT INTO DATA_VAULT.CORE.SAT_STUDYLINK_APPLICATION_FILE (SAT_STUDYLINK_APPLICATION_FILE_SK,
                                                            HUB_STUDYLINK_APPLICATION_KEY,
                                                            SOURCE,
                                                            LOAD_DTS,
                                                            ETL_JOB_ID,
                                                            HASH_MD5,
                                                            APPLICATIONID,
                                                            STUDENT_ID,
                                                            CATEGORY,
                                                            TITLE,
                                                            GIVEN_NAME,
                                                            FAMILY_NAME,
                                                            TEAM,
                                                            SUBMISSION_DATE,
                                                            CITIZENSHIP,
                                                            COUNTRY_OF_BIRTH,
                                                            REQUESTED_ELP,
                                                            DATE_OF_BIRTH,
                                                            GENDER,
                                                            EMAIL,
                                                            PHONE,
                                                            MOBILE,
                                                            HOME_ADDRESS_STREET,
                                                            HOME_ADDRESS_STREET_2,
                                                            HOME_ADDRESS_STREET_3,
                                                            HOME_ADDRESS_CITY,
                                                            HOME_ADDRESS_POSTCODE,
                                                            HOME_ADDRESS_STATE,
                                                            HOME_ADDRESS_COUNTRY,
                                                            CONTACT_PHONE,
                                                            CONTACT_ADDRESS_STREET,
                                                            CONTACT_ADDRESS_STREET_2,
                                                            CONTACT_ADDRESS_STREET_3,
                                                            CONTACT_ADDRESS_CITY,
                                                            CONTACT_ADDRESS_POSTCODE,
                                                            CONTACT_ADDRESS_STATE,
                                                            CONTACT_ADDRESS_COUNTRY,
                                                            APPLY_METHOD,
                                                            AGENCY_NAME,
                                                            AGENCY_CODE,
                                                            AGENCY_COUNTRY,
                                                            AGENCY_EMAIL,
                                                            REQUESTED_RPL,
                                                            PREV_INST_COUNTRY,
                                                            PREV_INST,
                                                            PREV_INST_OTHER,
                                                            PREV_QUAL,
                                                            APP_STATUS_DESCRIPTION,
                                                            WITHDRAW_REASON,
                                                            LAST_MODIFIED_DATE,
                                                            GPA_OR_ATAR,
                                                            SCHOLARSHIP1_NAME,
                                                            SCHOLARSHIP1_STATUS,
                                                            SCHOLARSHIP1_YEAR,
                                                            SCHOLARSHIP2_NAME,
                                                            SCHOLARSHIP2_STATUS,
                                                            SCHOLARSHIP2_YEAR,
                                                            SCHOLARSHIP3_NAME,
                                                            SCHOLARSHIP3_STATUS,
                                                            SCHOLARSHIP3_YEAR,
                                                            SCHOLARSHIP4_NAME,
                                                            SCHOLARSHIP4_STATUS,
                                                            SCHOLARSHIP4_YEAR,
                                                            OFFER_START_DATE,
                                                            OFFER_END_DATE,
                                                            OFFER_DURATION,
                                                            OFFER_DURATION_REMAINING,
                                                            ADMISSIONS_FIRST_NAME,
                                                            ADMISSIONS_LAST_NAME,
                                                            DATE_OFFER_MADE,
                                                            EVENT_COUNTRY,
                                                            EVENT_CODE,
                                                            FIRST_S1_CODE,
                                                            FIRST_PROGRAM_NAME,
                                                            FIRST_INTAKE_CODE,
                                                            FIRST_INTAKE_DESC,
                                                            FIRST_CAMPUS,
                                                            FIRST_FACULTY,
                                                            FIRST_COURSE_TYPE,
                                                            FIRST_RPL,
                                                            FIRST_MAJOR,
                                                            LAST_S1_CODE,
                                                            LAST_PROGRAM_NAME,
                                                            LAST_INTAKE_CODE,
                                                            LAST_INTAKE_DESC,
                                                            LAST_CAMPUS,
                                                            LAST_FACULTY,
                                                            LAST_COURSE_TYPE,
                                                            LAST_RPL,
                                                            LAST_MAJOR,
                                                            ENG_S1_CODE,
                                                            ENG_PROGRAM_NAME,
                                                            ENG_INTAKE_CODE,
                                                            ENG_INTAKE_DESC,
                                                            ENG_CAMPUS,
                                                            ENG_FACULTY,
                                                            ENG_COURSE_TYPE,
                                                            ENG_RPL,
                                                            FND_S1_CODE,
                                                            FND_PROGRAM_NAME,
                                                            FND_INTAKE_CODE,
                                                            FND_INTAKE_DESC,
                                                            FND_CAMPUS,
                                                            FND_FACULTY,
                                                            FND_COURSE_TYPE,
                                                            FND_RPL,
                                                            DIP_S1_CODE,
                                                            DIP_PROGRAM_NAME,
                                                            DIP_INTAKE_CODE,
                                                            DIP_INTAKE_DESC,
                                                            DIP_CAMPUS,
                                                            DIP_FACULTY,
                                                            DIP_COURSE_TYPE,
                                                            DIP_RPL,
                                                            GCGD_S1_CODE,
                                                            GCGD_PROGRAM_NAME,
                                                            GCGD_INTAKE_CODE,
                                                            GCGD_INTAKE_DESC,
                                                            GCGD_CAMPUS,
                                                            GCGD_FACULTY,
                                                            GCGD_COURSE_TYPE,
                                                            GCGD_RPL,
                                                            DEG_S1_CODE,
                                                            DEG_PROGRAM_NAME,
                                                            DEG_INTAKE_CODE,
                                                            DEG_INTAKE_DESC,
                                                            DEG_CAMPUS,
                                                            DEG_FACULTY,
                                                            DEG_COURSE_TYPE,
                                                            DEG_RPL,
                                                            DEG_MAJOR,
                                                            SAE_CAMPUS,
                                                            SAE_COURSE_TYPE,
                                                            SAE_FACULTY,
                                                            SAE_INTAKE_CODE,
                                                            SAE_INTAKE_DESC,
                                                            SAE_MAJOR,
                                                            SAE_PROGRAM_NAME,
                                                            SAE_RPL,
                                                            SAE_S1_CODE,
                                                            INSTITUTION_ID,
                                                            LIABILITY_CATEGORY,
                                                            PARTNER_INSTITUTION,
                                                            PASSPORT_NUMBER,
                                                            SCORE_TYPE,
                                                            YEAR_OF_COMPLETION,
                                                            FILE_NOTE,
                                                            FILE_DATE,
                                                            CITIZENSHIP_TYPE,
                                                            STUDY_LEVEL_AND_PATHWAY,
                                                            MUIC_LEVEL_AND_PATHWAY,
                                                            FILTER_CATEGORY,
                                                            IS_DELETED)
SELECT DATA_VAULT.CORE.SEQ.NEXTVAL               SAT_STUDYLINK_APPLICATION_FILE_SK,
       MD5(S.APPLICATIONID)                      HUB_STUDYLINK_APPLICATION_KEY,
       'STUDYLINK'                               SOURCE,
       FILE_DATE                                 LOAD_DTS,
       'SQL' || CURRENT_TIMESTAMP::TIMESTAMP_NTZ ETL_JOB_ID,
       MD5_CHECKSUM                              HASH_MD5,
       APPLICATIONID,
       STUDENT_ID,
       CATEGORY,
       TITLE,
       GIVEN_NAME,
       FAMILY_NAME,
       TEAM,
       SUBMISSION_DATE,
       CITIZENSHIP,
       COUNTRY_OF_BIRTH,
       REQUESTED_ELP,
       DATE_OF_BIRTH,
       GENDER,
       EMAIL,
       PHONE,
       MOBILE,
       HOME_ADDRESS_STREET,
       HOME_ADDRESS_STREET_2,
       HOME_ADDRESS_STREET_3,
       HOME_ADDRESS_CITY,
       HOME_ADDRESS_POSTCODE,
       HOME_ADDRESS_STATE,
       HOME_ADDRESS_COUNTRY,
       CONTACT_PHONE,
       CONTACT_ADDRESS_STREET,
       CONTACT_ADDRESS_STREET_2,
       CONTACT_ADDRESS_STREET_3,
       CONTACT_ADDRESS_CITY,
       CONTACT_ADDRESS_POSTCODE,
       CONTACT_ADDRESS_STATE,
       CONTACT_ADDRESS_COUNTRY,
       APPLY_METHOD,
       AGENCY_NAME,
       AGENCY_CODE,
       AGENCY_COUNTRY,
       AGENCY_EMAIL,
       REQUESTED_RPL,
       PREV_INST_COUNTRY,
       PREV_INST,
       PREV_INST_OTHER,
       PREV_QUAL,
       APP_STATUS_DESCRIPTION,
       WITHDRAW_REASON,
       LAST_MODIFIED_DATE,
       GPA_OR_ATAR,
       SCHOLARSHIP1_NAME,
       SCHOLARSHIP1_STATUS,
       SCHOLARSHIP1_YEAR,
       SCHOLARSHIP2_NAME,
       SCHOLARSHIP2_STATUS,
       SCHOLARSHIP2_YEAR,
       SCHOLARSHIP3_NAME,
       SCHOLARSHIP3_STATUS,
       SCHOLARSHIP3_YEAR,
       SCHOLARSHIP4_NAME,
       SCHOLARSHIP4_STATUS,
       SCHOLARSHIP4_YEAR,
       OFFER_START_DATE,
       OFFER_END_DATE,
       OFFER_DURATION,
       OFFER_DURATION_REMAINING,
       ADMISSIONS_FIRST_NAME,
       ADMISSIONS_LAST_NAME,
       DATE_OFFER_MADE,
       EVENT_COUNTRY,
       EVENT_CODE,
       FIRST_S1_CODE,
       FIRST_PROGRAM_NAME,
       FIRST_INTAKE_CODE,
       FIRST_INTAKE_DESC,
       FIRST_CAMPUS,
       FIRST_FACULTY,
       FIRST_COURSE_TYPE,
       FIRST_RPL,
       FIRST_MAJOR,
       LAST_S1_CODE,
       LAST_PROGRAM_NAME,
       LAST_INTAKE_CODE,
       LAST_INTAKE_DESC,
       LAST_CAMPUS,
       LAST_FACULTY,
       LAST_COURSE_TYPE,
       LAST_RPL,
       LAST_MAJOR,
       ENG_S1_CODE,
       ENG_PROGRAM_NAME,
       ENG_INTAKE_CODE,
       ENG_INTAKE_DESC,
       ENG_CAMPUS,
       ENG_FACULTY,
       ENG_COURSE_TYPE,
       ENG_RPL,
       FND_S1_CODE,
       FND_PROGRAM_NAME,
       FND_INTAKE_CODE,
       FND_INTAKE_DESC,
       FND_CAMPUS,
       FND_FACULTY,
       FND_COURSE_TYPE,
       FND_RPL,
       DIP_S1_CODE,
       DIP_PROGRAM_NAME,
       DIP_INTAKE_CODE,
       DIP_INTAKE_DESC,
       DIP_CAMPUS,
       DIP_FACULTY,
       DIP_COURSE_TYPE,
       DIP_RPL,
       GCGD_S1_CODE,
       GCGD_PROGRAM_NAME,
       GCGD_INTAKE_CODE,
       GCGD_INTAKE_DESC,
       GCGD_CAMPUS,
       GCGD_FACULTY,
       GCGD_COURSE_TYPE,
       GCGD_RPL,
       DEG_S1_CODE,
       DEG_PROGRAM_NAME,
       DEG_INTAKE_CODE,
       DEG_INTAKE_DESC,
       DEG_CAMPUS,
       DEG_FACULTY,
       DEG_COURSE_TYPE,
       DEG_RPL,
       DEG_MAJOR,
       FILE_NOTE,
       INSTITUTION_ID,
       LIABILITY_CATEGORY,
       PARTNER_INSTITUTION,
       PASSPORT_NUMBER,
       SAE_CAMPUS,
       SAE_COURSE_TYPE,
       SAE_FACULTY,
       SAE_INTAKE_CODE,
       SAE_INTAKE_DESC,
       SAE_MAJOR,
       SAE_PROGRAM_NAME,
       SAE_RPL,
       SAE_S1_CODE,
       SCORE_TYPE,
       YEAR_OF_COMPLETION,
       FILE_DATE,
       LIABILITY_CATEGORY                        CITIZENSHIP_TYPE,
       CASE
           WHEN SAE_S1_CODE IS NOT NULL AND
                UPPER(SAE_S1_CODE) LIKE '%EXCH%'
               THEN 'NON_AWARD_EXCHANGE'
           WHEN SAE_S1_CODE IS NOT NULL AND
                UPPER(SAE_S1_CODE) NOT LIKE '%EXCH%'
               THEN 'NON_AWARD_STUDY_ABROAD'
           WHEN (DEG_COURSE_TYPE IS NOT NULL OR
                 GCGD_COURSE_TYPE IS NOT NULL
                    )
               AND ( (DEG_COURSE_TYPE IS NOT NULL
                   AND UPPER(DEG_COURSE_TYPE) NOT LIKE '%BACHELORS%')
               OR DEG_COURSE_TYPE IS NULL )
               THEN 'PG COURSEWORK'
           WHEN UPPER(DIP_COURSE_TYPE) LIKE '%DIPLOMA%' AND
                UPPER(DEG_COURSE_TYPE) LIKE '%BACHELORS%'
               THEN 'UG VIA MUIC DIPLOMA'
           WHEN UPPER(FND_COURSE_TYPE) LIKE '%FOUNDATION%' AND
                UPPER(DEG_COURSE_TYPE) LIKE '%BACHELORS%'
               THEN 'UG VIA MUIC FOUNDATION (OR MQC)'
           WHEN UPPER(CATEGORY) LIKE '%SIBT%' AND
                UPPER(DEG_COURSE_TYPE) LIKE '%BACHELORS%'
               THEN 'UG VIA SIBT DIPLOMA'
           WHEN UPPER(CATEGORY) LIKE '%UG TRANSFERS%' AND
                UPPER(DEG_COURSE_TYPE) LIKE '%BACHELORS%'
               THEN 'UG TRANSFER'
           WHEN UPPER(DEG_COURSE_TYPE) LIKE '%BACHELORS%'
               THEN 'UG DIRECT'
           WHEN UPPER(ENG_S1_CODE) LIKE '%ONLY%' AND
                FND_COURSE_TYPE IS NULL AND
                DIP_COURSE_TYPE IS NULL AND
                SAE_COURSE_TYPE IS NULL AND
                GCGD_COURSE_TYPE IS NULL AND
                DEG_COURSE_TYPE IS NULL
               THEN 'ELC ONLY'
           ELSE 'MUIC ONLY'
           END                                   STUDY_LEVEL_AND_PATHWAY,
       CASE
           WHEN UPPER(DIP_COURSE_TYPE) LIKE '%DIPLOMA%' AND
                UPPER(FND_COURSE_TYPE) LIKE '%FOUNDATION%'
               THEN 'DIPLOMA VIA FOUNDATION'
           WHEN (UPPER(DIP_COURSE_TYPE) LIKE '%DIPLOMA%' AND FND_COURSE_TYPE IS NULL)
               OR
                (UPPER(DIP_COURSE_TYPE) LIKE '%DIPLOMA%' AND UPPER(FND_COURSE_TYPE) NOT LIKE '%FOUNDATION%')
               THEN 'DIRECT DIPLOMA'
           WHEN (UPPER(DIP_COURSE_TYPE) NOT LIKE '%DIPLOMA%' AND UPPER(FND_COURSE_TYPE) LIKE '%FOUNDATION%')
               OR
                (UPPER(DIP_COURSE_TYPE) IS NULL AND UPPER(FND_COURSE_TYPE) LIKE '%FOUNDATION%')
               THEN 'FOUNDATION'
           END                                                     MUIC_LEVEL_AND_PATHWAY,
       CASE
           WHEN (UPPER(CATEGORY) LIKE '%TEST%' OR
                 UPPER(CATEGORY) LIKE '%FOUNDATION (DOMESTIC)%' OR
                 UPPER(APP_STATUS_DESCRIPTION) LIKE '%Received into AMRD%' OR
                 UPPER(DEG_S1_CODE) LIKE '%BCOMMTRANS%' OR
                 UPPER(FAMILY_NAME) LIKE '%CAOTEST%' OR
                 UPPER(CATEGORY) LIKE '%FOUNDATION (DOMESTI)%'
               ) THEN 'FALSE'
           ELSE 'TRUE' END                                         FILTER_CATEGORY,
       'N'                                                         IS_DELETED
FROM (
         SELECT APPLICATIONID,
                STUDENT_ID,
                CATEGORY,
                TITLE,
                GIVEN_NAME,
                FAMILY_NAME,
                TEAM,
                SUBMISSION_DATE,
                CITIZENSHIP,
                COUNTRY_OF_BIRTH,
                REQUESTED_ELP,
                DATE_OF_BIRTH,
                GENDER,
                EMAIL,
                PHONE,
                MOBILE,
                HOME_ADDRESS_STREET,
                HOME_ADDRESS_STREET_2,
                HOME_ADDRESS_STREET_3,
                HOME_ADDRESS_CITY,
                HOME_ADDRESS_POSTCODE,
                HOME_ADDRESS_STATE,
                HOME_ADDRESS_COUNTRY,
                CONTACT_PHONE,
                CONTACT_ADDRESS_STREET,
                CONTACT_ADDRESS_STREET_2,
                CONTACT_ADDRESS_STREET_3,
                CONTACT_ADDRESS_CITY,
                CONTACT_ADDRESS_POSTCODE,
                CONTACT_ADDRESS_STATE,
                CONTACT_ADDRESS_COUNTRY,
                APPLY_METHOD,
                AGENCY_NAME,
                AGENCY_CODE,
                AGENCY_COUNTRY,
                AGENCY_EMAIL,
                REQUESTED_RPL,
                PREV_INST_COUNTRY,
                PREV_INST,
                PREV_INST_OTHER,
                PREV_QUAL,
                APP_STATUS_DESCRIPTION,
                WITHDRAW_REASON,
                LAST_MODIFIED_DATE,
                GPA_OR_ATAR,
                SCHOLARSHIP1_NAME,
                SCHOLARSHIP1_STATUS,
                SCHOLARSHIP1_YEAR,
                SCHOLARSHIP2_NAME,
                SCHOLARSHIP2_STATUS,
                SCHOLARSHIP2_YEAR,
                SCHOLARSHIP3_NAME,
                SCHOLARSHIP3_STATUS,
                SCHOLARSHIP3_YEAR,
                SCHOLARSHIP4_NAME,
                SCHOLARSHIP4_STATUS,
                SCHOLARSHIP4_YEAR,
                OFFER_START_DATE,
                OFFER_END_DATE,
                OFFER_DURATION,
                OFFER_DURATION_REMAINING,
                ADMISSIONS_FIRST_NAME,
                ADMISSIONS_LAST_NAME,
                DATE_OFFER_MADE,
                EVENT_COUNTRY,
                EVENT_CODE,
                FIRST_S1_CODE,
                FIRST_PROGRAM_NAME,
                FIRST_INTAKE_CODE,
                FIRST_INTAKE_DESC,
                FIRST_CAMPUS,
                FIRST_FACULTY,
                FIRST_COURSE_TYPE,
                FIRST_RPL,
                FIRST_MAJOR,
                LAST_S1_CODE,
                LAST_PROGRAM_NAME,
                LAST_INTAKE_CODE,
                LAST_INTAKE_DESC,
                LAST_CAMPUS,
                LAST_FACULTY,
                LAST_COURSE_TYPE,
                LAST_RPL,
                LAST_MAJOR,
                ENG_S1_CODE,
                ENG_PROGRAM_NAME,
                ENG_INTAKE_CODE,
                ENG_INTAKE_DESC,
                ENG_CAMPUS,
                ENG_FACULTY,
                ENG_COURSE_TYPE,
                ENG_RPL,
                FND_S1_CODE,
                FND_PROGRAM_NAME,
                FND_INTAKE_CODE,
                FND_INTAKE_DESC,
                FND_CAMPUS,
                FND_FACULTY,
                FND_COURSE_TYPE,
                FND_RPL,
                DIP_S1_CODE,
                DIP_PROGRAM_NAME,
                DIP_INTAKE_CODE,
                DIP_INTAKE_DESC,
                DIP_CAMPUS,
                DIP_FACULTY,
                DIP_COURSE_TYPE,
                DIP_RPL,
                GCGD_S1_CODE,
                GCGD_PROGRAM_NAME,
                GCGD_INTAKE_CODE,
                GCGD_INTAKE_DESC,
                GCGD_CAMPUS,
                GCGD_FACULTY,
                GCGD_COURSE_TYPE,
                GCGD_RPL,
                DEG_S1_CODE,
                DEG_PROGRAM_NAME,
                DEG_INTAKE_CODE,
                DEG_INTAKE_DESC,
                DEG_CAMPUS,
                DEG_FACULTY,
                DEG_COURSE_TYPE,
                DEG_RPL,
                DEG_MAJOR,
                FILE_NOTE,
                INSTITUTION_ID,
                LIABILITY_CATEGORY,
                PARTNER_INSTITUTION,
                PASSPORT_NUMBER,
                SAE_CAMPUS,
                SAE_COURSE_TYPE,
                SAE_FACULTY,
                SAE_INTAKE_CODE,
                SAE_INTAKE_DESC,
                SAE_MAJOR,
                SAE_PROGRAM_NAME,
                SAE_RPL,
                SAE_S1_CODE,
                SCORE_TYPE,
                YEAR_OF_COMPLETION,
                FILE_DATE,
                MD5_CHECKSUM,
                IFF(MD5_CHECKSUM = LAG(MD5_CHECKSUM) OVER (PARTITION BY APPLICATIONID ORDER BY FILE_DATE ASC), 'N',
           'Y')                                                                   HAS_CHANGE
         FROM ODS.STUDYLINK.STUDYLINK_APPLICATION_CSV_EXTRACT
         WHERE APP_STATUS_DESCRIPTION  IS NOT NULL
     ) S
WHERE S.HAS_CHANGE='Y'
  AND NOT EXISTS(
        SELECT NULL
        FROM DATA_VAULT.CORE.SAT_STUDYLINK_APPLICATION_FILE FILE
        WHERE FILE.APPLICATIONID = S.APPLICATIONID
          AND FILE.FILE_DATE = S.FILE_DATE
    )
;
