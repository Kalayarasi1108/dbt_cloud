-- DELETE
INSERT INTO DATA_VAULT.CORE.SAT_STUDYLINK_APPLICATION (
                                                SAT_STUDYLINK_APPLICATION_SK,
                                                HUB_STUDYLINK_APPLICATION_KEY,
                                                SOURCE,
                                                LOAD_DTS,
                                                ETL_JOB_ID,
                                                HASH_MD5,
                                                IS_DELETED )
SELECT  DATA_VAULT.CORE.SEQ.NEXTVAL SAT_STUDYLINK_APPLICATION_SK,
        S.HUB_STUDYLINK_APPLICATION_KEY,
       'STUDYLINK' SOURCE,
       CURRENT_TIMESTAMP::TIMESTAMP_NTZ LOAD_DTS,
       'SQL' || CURRENT_TIMESTAMP::TIMESTAMP_NTZ ETL_JOB_ID,
       MD5('') HASH_MD5,
       'Y' IS_DELETED
FROM (
         SELECT SAT.HUB_STUDYLINK_APPLICATION_KEY,
                SAT.APPLICATIONID,
                SAT.LOAD_DTS,
                LEAD(SAT.LOAD_DTS) OVER(PARTITION BY SAT.HUB_STUDYLINK_APPLICATION_KEY ORDER BY SAT.LOAD_DTS ASC) EFFECTIVE_END_DTS,
                IS_DELETED
         FROM DATA_VAULT.CORE.SAT_STUDYLINK_APPLICATION SAT
                  JOIN DATA_VAULT.CORE.HUB_STUDYLINK_APPLICATION HUB
                       ON HUB.HUB_STUDYLINK_APPLICATION_KEY = SAT.HUB_STUDYLINK_APPLICATION_KEY AND HUB.SOURCE = 'STUDYLINK'
     ) S
WHERE S.EFFECTIVE_END_DTS IS NULL
  AND S.IS_DELETED = 'N'
  AND NOT EXISTS(
        SELECT NULL
        FROM  ODS.STUDYLINK.STUDYLINK_APPLICATION_API_LATEST V
        WHERE V.DF_APPLICATIONDETAILS_APPLICATIONID = S.APPLICATIONID
    )
;