-- DELETE
INSERT INTO DATA_VAULT.CORE.SAT_STUDENT_DET (SAT_STUDENT_DET_SK, HUB_STUDENT_KEY, SOURCE, LOAD_DTS, ETL_JOB_ID,
                                             HASH_MD5, STU_ID, STU_FAMILY_NM, STU_GVN_NM, STU_OTH_NM, STU_TITLE_CD,
                                             STU_ALIAS, STU_PREF_NM, STU_FORMAL_NM_1, STU_FORMAL_NM_2, STU_BIRTH_DT,
                                             STU_GENDER_CD, STU_INITS, STU_DECD_FG, STU_CITIZEN_CD, STU_CTZN_CONF_DT,
                                             STU_PRM_RSD_CD, STU_PRM_RSD_DT, STU_PRM_RSD_MET_CD, STU_RSD_AUST_CD,
                                             STU_RSD_OUT_AUS_CD, STU_BIRTH_CNTRY_CD, STU_ENTRY_YR, STU_HOME_LANG_CD,
                                             STU_ABOR_TSI_CD, CURR_EMP_STTS_CD, SCH_LVL_COM_CD, AT_SCHOOL_FG,
                                             GV4_STUDY_REAS_CD, CRDATEI, CRTIMEI, LAST_MOD_DATEI, LAST_MOD_TIMEI,
                                             STU_YOE_UNKNOWN_FG, STU_CONSOL_FG, CONSOL_TO_STU_ID, CITIZEN_EFFCT_DT,
                                             NAME_EFFCT_DT, NAME_CHG_RSN_CD, STU_CTZN_CNTRY_CD, YR12_EXT_ORG_ID,
                                             YR12_STU_ID, YR12_YEAR, YR12_STATE, STU_HLA_CODE, STU_HLA_YEAR,
                                             STU_HLA_MOD_DT, YR12_COMP_FG, STU_DISAB_FG, STU_DISAB_INFO_FG,
                                             STU_PREF_CORR_METH_CD, STU_CTZN_SELF_NOM_FG, PREF_CONTACT_METH_CD,
                                             YR12_RSLT_TYPE_CD, STU_PROF_SPOKEN_CD, SCH_LVL_COM_YEAR,
                                             CURR_SCHOOL_EXT_ORG_ID, STU_DUAL_CTZN_CNTRY_CD, VISA_TYPE_CD,
                                             VISA_SUB_TYPE_CD, STATUS_CD, NATIONALITY_CD, LENGTH_OF_RESIDENCE_CD,
                                             PURPOSE_OF_RESIDENCE, TEMPORARY_ABSENCE_CD, RESIDENTIAL_CATEGORY_CD,
                                             COUNTRY_ORDINARY_RESIDENCE, IS_DELETED)
SELECT CORE.SEQ.NEXTVAL                          SAT_STUDENT_DET_SK,
       MD5(S.STU_ID)                             HUB_STUDENT_KEY,
       'AMIS'                                    SOURCE,
       CURRENT_TIMESTAMP::TIMESTAMP_NTZ          LOAD_DTS,
       'SQL' || CURRENT_TIMESTAMP::TIMESTAMP_NTZ ETL_JOB_ID,
       MD5('')                                   HASH_MD5,
       NULL                                      STU_ID,
       NULL                                      STU_FAMILY_NM,
       NULL                                      STU_GVN_NM,
       NULL                                      STU_OTH_NM,
       NULL                                      STU_TITLE_CD,
       NULL                                      STU_ALIAS,
       NULL                                      STU_PREF_NM,
       NULL                                      STU_FORMAL_NM_1,
       NULL                                      STU_FORMAL_NM_2,
       NULL                                      STU_BIRTH_DT,
       NULL                                      STU_GENDER_CD,
       NULL                                      STU_INITS,
       NULL                                      STU_DECD_FG,
       NULL                                      STU_CITIZEN_CD,
       NULL                                      STU_CTZN_CONF_DT,
       NULL                                      STU_PRM_RSD_CD,
       NULL                                      STU_PRM_RSD_DT,
       NULL                                      STU_PRM_RSD_MET_CD,
       NULL                                      STU_RSD_AUST_CD,
       NULL                                      STU_RSD_OUT_AUS_CD,
       NULL                                      STU_BIRTH_CNTRY_CD,
       NULL                                      STU_ENTRY_YR,
       NULL                                      STU_HOME_LANG_CD,
       NULL                                      STU_ABOR_TSI_CD,
       NULL                                      CURR_EMP_STTS_CD,
       NULL                                      SCH_LVL_COM_CD,
       NULL                                      AT_SCHOOL_FG,
       NULL                                      GV4_STUDY_REAS_CD,
       NULL                                      CRDATEI,
       NULL                                      CRTIMEI,
       NULL                                      LAST_MOD_DATEI,
       NULL                                      LAST_MOD_TIMEI,
       NULL                                      STU_YOE_UNKNOWN_FG,
       NULL                                      STU_CONSOL_FG,
       NULL                                      CONSOL_TO_STU_ID,
       NULL                                      CITIZEN_EFFCT_DT,
       NULL                                      NAME_EFFCT_DT,
       NULL                                      NAME_CHG_RSN_CD,
       NULL                                      STU_CTZN_CNTRY_CD,
       NULL                                      YR12_EXT_ORG_ID,
       NULL                                      YR12_STU_ID,
       NULL                                      YR12_YEAR,
       NULL                                      YR12_STATE,
       NULL                                      STU_HLA_CODE,
       NULL                                      STU_HLA_YEAR,
       NULL                                      STU_HLA_MOD_DT,
       NULL                                      YR12_COMP_FG,
       NULL                                      STU_DISAB_FG,
       NULL                                      STU_DISAB_INFO_FG,
       NULL                                      STU_PREF_CORR_METH_CD,
       NULL                                      STU_CTZN_SELF_NOM_FG,
       NULL                                      PREF_CONTACT_METH_CD,
       NULL                                      YR12_RSLT_TYPE_CD,
       NULL                                      STU_PROF_SPOKEN_CD,
       NULL                                      SCH_LVL_COM_YEAR,
       NULL                                      CURR_SCHOOL_EXT_ORG_ID,
       NULL                                      STU_DUAL_CTZN_CNTRY_CD,
       NULL                                      VISA_TYPE_CD,
       NULL                                      VISA_SUB_TYPE_CD,
       NULL                                      STATUS_CD,
       NULL                                      NATIONALITY_CD,
       NULL                                      LENGTH_OF_RESIDENCE_CD,
       NULL                                      PURPOSE_OF_RESIDENCE,
       NULL                                      TEMPORARY_ABSENCE_CD,
       NULL                                      RESIDENTIAL_CATEGORY_CD,
       NULL                                      COUNTRY_ORDINARY_RESIDENCE,
       'Y'                                       IS_DELETED
FROM (
         SELECT HUB.STU_ID,
                SAT.HUB_STUDENT_KEY,
                SAT.LOAD_DTS,
                LEAD(SAT.LOAD_DTS) OVER(PARTITION BY SAT.HUB_STUDENT_KEY ORDER BY SAT.LOAD_DTS ASC) EFFECTIVE_END_DTS,
                IS_DELETED
         FROM DATA_VAULT.CORE.SAT_STUDENT_DET SAT
                  JOIN DATA_VAULT.CORE.HUB_STUDENT HUB
                       ON HUB.HUB_STUDENT_KEY = SAT.HUB_STUDENT_KEY AND HUB.SOURCE = 'AMIS'
     ) S
WHERE S.EFFECTIVE_END_DTS IS NULL
  AND S.IS_DELETED = 'N'
  AND NOT EXISTS(
        SELECT NULL
        FROM ODS.AMIS.S1STU_DET STU_DET
        WHERE STU_DET.STU_ID = S.STU_ID
    )
;